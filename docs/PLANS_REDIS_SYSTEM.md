# –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞–Ω–∞–º–∏ –ø–æ–¥–ø–∏—Å–∫–∏ —Å Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ Redis –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. PaymentService

- –ü–æ–ª—É—á–∞–µ—Ç –ø–ª–∞–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### 2. PlanAdminService

- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞–Ω–∞–º–∏
- –°–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–ª–∞–Ω–æ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–ª–∞–Ω–∞–º –∏ –ø–ª–∞—Ç–µ–∂–∞–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

### 3. RedisCacheModule

- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- TTL: 24 —á–∞—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–æ–ª–µ–π –∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à `.env` —Ñ–∞–π–ª:

```bash
# Redis Cache
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### SubscriptionPlan

```sql
CREATE TABLE "SubscriptionPlan" (
  id SERIAL PRIMARY KEY,
  name VARCHAR NOT NULL,
  durationDays INTEGER NOT NULL,
  price BIGINT NOT NULL, -- –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  currency VARCHAR NOT NULL,
  description TEXT,
  isActive BOOLEAN DEFAULT true,
  createdAt TIMESTAMP DEFAULT NOW(),
  updatedAt TIMESTAMP DEFAULT NOW()
);
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤

```typescript
// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
const plans = await paymentService.getPlans();

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
const plan = await paymentService.getPlanById('1');
```

### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞
const newPlan = await planAdminService.createPlan({
  name: 'üÜï –ù–æ–≤—ã–π –ø–ª–∞–Ω',
  durationDays: 60,
  price: 39900, // 399 —Ä—É–±–ª–µ–π –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  currency: 'RUB',
  description: '2 –º–µ—Å—è—Ü–∞ VPN –¥–æ—Å—Ç—É–ø–∞',
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞
await planAdminService.updatePlan(1, {
  price: 49900, // –Ω–æ–≤–∞—è —Ü–µ–Ω–∞
});

// –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–ª–∞–Ω–∞
await planAdminService.deletePlan(1);
```

## –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–ª—é—á–∏ –∫—ç—à–∞

- `payment_plans` - –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏

### TTL (–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏)

- –ü–ª–∞–Ω—ã: 24 —á–∞—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
2. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –∑–∞–ø—Ä–æ—Å –∫ –ë–î
3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

## –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤:

```bash
npm run build
npx ts-node scripts/seed-plans.ts
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- `[PAYMENT] Plans loaded from cache` - –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞
- `[PAYMENT] Loading plans from database` - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ë–î
- `[PAYMENT] Plans cached for X seconds` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
- `[ADMIN] Created/Updated/Deactivated plan` - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```typescript
const stats = await planAdminService.getPlansStatistics();
console.log(stats);
// {
//   totalPlans: 3,
//   activePlans: 3,
//   inactivePlans: 0,
//   paymentsByPlan: [...]
// }
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:

- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫ API (< 1ms –∏–∑ –∫—ç—à–∞ vs ~10-50ms –∏–∑ –ë–î)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º
- –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –≤—ã—Å–æ–∫–∏–º –Ω–∞–≥—Ä—É–∑–∫–∞–º

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π Redis —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Redis
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ hit rate –∫—ç—à–∞
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–≤–µ–ª–∏—á—å—Ç–µ TTL –¥–ª—è –ø–ª–∞–Ω–æ–≤ (–æ–Ω–∏ —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è)

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º—ã —Å Redis

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: `redis-cli ping`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. Fallback: —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ Redis, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–ª–∞–Ω–∞–º–∏

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–ª–∞–Ω–æ–≤ –≤ –ë–î: `SELECT * FROM "SubscriptionPlan";`
2. –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à: `await paymentService.clearPlansCache()`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏: `npx prisma migrate status`

### –û—Ç–ª–∞–¥–∫–∞ –∫—ç—à–∞

```typescript
// –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
await paymentService.clearPlansCache();

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫—ç—à–∞
const cached = await cacheManager.get('payment_plans');
console.log('Cached plans:', cached);
```
