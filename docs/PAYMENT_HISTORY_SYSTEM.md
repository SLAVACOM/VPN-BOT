# –°–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å Payment

- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –¥–ª—è Telegram Payments
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
- –°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π (pending, completed, failed, cancelled)
- –°–≤—è–∑—å —Å –ø–ª–∞–Ω–∞–º–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–Ω—è—Ö

### 2. PaymentHistoryService

- **CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏** –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
- **–ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–µ–π** –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π** –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- **–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PaymentService

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

### 4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

- –ö–æ–º–∞–Ω–¥–∞ `/payments` - –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–Ω–æ–ø–∫–∞ "üí≥ –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
- –ê–¥–º–∏–Ω—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ `/paymentstats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –ö–Ω–æ–ø–∫–∞ "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π" –≤ –∞–¥–º–∏–Ω—Å–∫–æ–º –º–µ–Ω—é

## üöÄ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

```
/payments - –ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

- –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ (‚úÖ —É—Å–ø–µ—à–Ω–æ, ‚è≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, ‚ùå –Ω–µ—É–¥–∞—á–Ω–æ)
- –°—É–º–º—É –∏ –¥–∞—Ç—É
- –ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–Ω–µ–π

### –î–ª—è –∞–¥–º–∏–Ω–æ–≤:

```
/paymentstats - –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

- –û–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å—É–º–º—ã)
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ –º–µ—Ç–æ–¥–∞–º –æ–ø–ª–∞—Ç—ã
- –°—Ä–µ–¥–Ω—é—é —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–æ–¥–µ–ª—å Payment (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è):

```prisma
model Payment {
  id                     Int      @id @default(autoincrement())
  userId                 Int
  amount                 Float    // –°—É–º–º–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  currency               String   // –í–∞–ª—é—Ç–∞
  method                 String   // telegram_payments, yookassa
  status                 String   // pending, completed, failed

  // Telegram Payments
  telegramPaymentChargeId  String? @unique
  providerPaymentChargeId  String?
  invoicePayload          String?

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  daysAdded              Int?     // –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–Ω–∏
  description            String?  // –û–ø–∏—Å–∞–Ω–∏–µ
  metadata               Json?    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

  // –°–≤—è–∑–∏
  plan                   SubscriptionPlan?
  user                   User

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–ª–∞—Ç–µ–∂–∞

1. **–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞** ‚Üí –∑–∞–ø–∏—Å—å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
2. **–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞** ‚Üí —Å—Ç–∞—Ç—É—Å `completed` + –¥–∞–Ω–Ω—ã–µ Telegram
3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–Ω–µ–π** ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è `daysAdded`

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ:

- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å –ø–ª–∞–Ω–æ–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

## üìã –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```typescript
const payments = await paymentHistoryService.getUserPaymentHistory(userId, 10);
```

### –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:

```typescript
const stats = await paymentHistoryService.getPaymentStatistics();
console.log(`–í—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π: ${stats.totalPayments}`);
console.log(`–û–±—â–∞—è —Å—É–º–º–∞: ${stats.totalAmount / 100} ‚ÇΩ`);
```

### –ù–∞–π—Ç–∏ –ø–ª–∞—Ç–µ–∂ –ø–æ Telegram ID:

```typescript
const payment = await paymentHistoryService.findByTelegramChargeId(chargeId);
```

## üîß –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

- **–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏**: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å—É–º–º—ã, —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
- **–ü–æ —Å—Ç–∞—Ç—É—Å–∞–º**: —Å–∫–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- **–ü–æ –º–µ—Ç–æ–¥–∞–º**: —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã
- **–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏**: –¥–µ—Ç–∞–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üîç –û—Ç–ª–∞–¥–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã:

```
[PAYMENT_HISTORY] Created payment record: ID=123, user=456, amount=19900, status=pending
[PAYMENT_HISTORY] Updated payment record: ID=123, status=completed
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

- `/payments` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/paymentstats` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–∏—Å—Ç–µ–º–µ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î: `SELECT * FROM "Payment" ORDER BY "createdAt" DESC;`

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–°—É–º–º—ã –≤ –∫–æ–ø–µ–π–∫–∞—Ö**: –≤—Å–µ amount —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–æ–ø–µ–π–∫–∞—Ö
2. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ JSON**: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
3. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å**: `telegramPaymentChargeId` —É–Ω–∏–∫–∞–ª–µ–Ω
4. **–°—Ç–∞—Ç—É—Å—ã**: `pending` ‚Üí `completed` / `failed`
5. **–°–≤—è–∑–∏**: –ø–ª–∞—Ç–µ–∂ –≤—Å–µ–≥–¥–∞ —Å–≤—è–∑–∞–Ω —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –ø–ª–∞–Ω–æ–º

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

- ‚úÖ –ü–æ–ª–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏ —Å–±–æ—è—Ö
- ‚úÖ –ê—É–¥–∏—Ç –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏
