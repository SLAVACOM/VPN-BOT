# –ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –ø–ª–∞–Ω–æ–≤

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–ª–∞–Ω–æ–≤**: –ü–ª–∞–Ω—ã —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL —Ç–∞–±–ª–∏—Ü–µ `SubscriptionPlan`
2. **Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
3. **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞–Ω–∞–º–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞**: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ø–ª–∞–Ω–æ–≤ –∫—ç—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

## üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Redis

```bash
# Windows (—á–µ—Ä–µ–∑ Chocolatey)
choco install redis-64

# Ubuntu/Debian
sudo apt install redis-server

# macOS (—á–µ—Ä–µ–∑ Homebrew)
brew install redis
```

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –î–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–ª–∞–Ω—ã

```bash
npx prisma migrate dev
npx ts-node scripts/seed-plans.ts
```

### 4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞

```bash
npm run start:dev
```

## üìã –ù–æ–≤—ã–µ –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

- `/listplans` - –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–ª–∞–Ω–æ–≤ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- `/clearplanscache` - –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–ª–∞–Ω–æ–≤
- –ö–Ω–æ–ø–∫–∏ –≤ –∞–¥–º–∏–Ω—Å–∫–æ–º –º–µ–Ω—é: "üìã –°–ø–∏—Å–æ–∫ –ø–ª–∞–Ω–æ–≤", "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à"

## üîß –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ü–ª–∞–Ω—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ Redis –Ω–∞ 24 —á–∞—Å–∞
2. **–ì–∏–±–∫–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–ª–∞–Ω—ã —á–µ—Ä–µ–∑ –ë–î
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –≤—ã—Å–æ–∫–∏–º –Ω–∞–≥—Ä—É–∑–∫–∞–º
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
5. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: Fallback –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã:

- `[PAYMENT] Plans loaded from cache` - –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞
- `[PAYMENT] Loading plans from database` - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ë–î
- `[PAYMENT] Plans cached for 86400 seconds` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
- `[ADMIN] Created/Updated/Deactivated plan` - –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞–Ω–∞–º–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

- `/listplans` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö/–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
- Redis CLI: `redis-cli info keyspace` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—ç—à–µ

## üîÑ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞ —á–µ—Ä–µ–∑ –∫–æ–¥:

```typescript
const newPlan = await planAdminService.createPlan({
  name: 'üÜï –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π',
  durationDays: 15,
  price: 9900, // 99 —Ä—É–±–ª–µ–π –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  currency: 'RUB',
  description: '2 –Ω–µ–¥–µ–ª–∏ VPN –¥–æ—Å—Ç—É–ø–∞',
});
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞:

```typescript
await planAdminService.updatePlan(planId, {
  price: 14900, // –Ω–æ–≤–∞—è —Ü–µ–Ω–∞
  isActive: true,
});
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–¶–µ–Ω—ã –≤ –∫–æ–ø–µ–π–∫–∞—Ö**: –í—Å–µ —Ü–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–æ–ø–µ–π–∫–∞—Ö (199‚ÇΩ = 19900)
2. **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞**: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–æ–≤ –∫—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. **Fallback**: –ï—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å –ë–î
4. **TTL –∫—ç—à–∞**: 24 —á–∞—Å–∞, –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `PaymentService.CACHE_TTL`

## üîß Troubleshooting

**Redis –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: `redis-cli ping` –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `PONG`
- –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ Redis, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ

**–ü–ª–∞–Ω—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è:**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î: `SELECT * FROM "SubscriptionPlan";`
- –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à: `/clearplanscache`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

**–ü—Ä–æ–±–ª–µ–º—ã —Å –∫—ç—à–µ–º:**

- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Redis: `redis-server`
- –û—á–∏—Å—Ç–∏—Ç–µ –≤–µ—Å—å –∫—ç—à: `redis-cli flushall`
