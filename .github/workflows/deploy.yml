name: Deploy via Docker Compose

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "üì¶ --- –ù–ê–ß–ê–õ–û –î–ï–ü–õ–û–Ø VPN-BOT --- üì¶"

            cd ~/bot/VPN-BOT || exit 1

            echo ""
            echo "üìå –ö–æ–º–º–∏—Ç –¥–æ pull:"
            git log -1 --pretty=format:"%h ‚Äî %s (%an, %cd)" || echo "Git –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"

            echo ""
            echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç —á–µ—Ä–µ–∑ git pull..."
            git pull origin main

            echo ""
            echo "üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã:"
            git log -5 --pretty=format:"%h ‚Äî %s (%an)"

            echo ""
            echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
            docker-compose down
            docker-compose up -d --build

            echo ""
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            sleep 20

            echo ""
            echo "üóÑÔ∏è –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è):"
            docker-compose exec -T app npx prisma migrate deploy || echo "–ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)"

            echo ""
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker-compose ps

            echo ""
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö Docker-–æ–±—Ä–∞–∑–æ–≤:"
            docker image prune -f

            echo ""
            echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            curl -fs http://localhost:3000/health && echo '‚úÖ Health OK' || echo '‚ùå Health check –Ω–µ –ø—Ä–æ–π–¥–µ–Ω'

      - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (—É—Å–ø–µ—Ö)
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          message: |
            ‚úÖ <b>–£—Å–ø–µ—à–Ω—ã–π –¥–µ–ø–ª–æ–π VPN-BOT!</b><br><br>
            üóÇ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: <code>${{ github.repository }}</code><br>
            üåø –í–µ—Ç–∫–∞: <code>${{ github.ref_name }}</code><br>
            üî® –ö–æ–º–º–∏—Ç: <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">${{ github.sha }}</a><br>
            üåç –°–µ—Ä–≤–µ—Ä: <code>${{ secrets.SSH_HOST }}</code><br><br>
            –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã, –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã, –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω ‚úÖ

      - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (–æ—à–∏–±–∫–∞)
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          message: |
            ‚ùå <b>–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ VPN-BOT!</b><br><br>
            üóÇ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: <code>${{ github.repository }}</code><br>
            üåø –í–µ—Ç–∫–∞: <code>${{ github.ref_name }}</code><br>
            üî® –ö–æ–º–º–∏—Ç: <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">${{ github.sha }}</a><br><br>
            ‚ö†Ô∏è –õ–æ–≥–∏: <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">–ü–µ—Ä–µ–π—Ç–∏ –∫ workflow</a>
