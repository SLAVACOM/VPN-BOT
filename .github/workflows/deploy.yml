name: Deploy via Docker Compose

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy with SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}

          script: |
            cd /opt/nest-tg-bot || exit 1

            echo "ðŸ“Œ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð´Ð¾ pull:"
            git log -1 --pretty=format:"%h â€” %s (%an, %cd)" || echo "Git Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"

            echo ""
            echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´..."
            if [ -d ".git" ]; then
              git pull origin main
            else
              echo "ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
              cd /opt
              rm -rf nest-tg-bot
              git clone https://github.com/SLAVACOM/VPN-BOT.git nest-tg-bot
              cd nest-tg-bot
            fi

            echo ""
            echo "ðŸ“œ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ pull:"
            git log HEAD@{1}..HEAD --pretty=format:"%h â€” %s (%an)" || git log -5 --pretty=format:"%h â€” %s (%an)"

            echo ""
            echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»..."
            cat > .env << 'EOF'
            DATABASE_NAME=${{ secrets.DATABASE_NAME }}
            DATABASE_USER=${{ secrets.DATABASE_USER }}
            DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            BOT_TOKEN=${{ secrets.BOT_TOKEN }}
            ADMIN_IDS=${{ secrets.ADMIN_IDS }}
            WIREGUARD_API=${{ secrets.WIREGUARD_API }}
            WIREGUARD_PASSWORD=${{ secrets.WIREGUARD_PASSWORD }}
            PAYMENT_PROVIDER_TOKEN=${{ secrets.PAYMENT_PROVIDER_TOKEN }}
            NODE_ENV=production
            TRIAL_PERIOD_DAYS=7
            APP_PORT=3000
            POSTGRES_PORT=5432
            REDIS_PORT=6379
            EOF

            echo ""
            echo "ðŸš€ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
            docker-compose down
            docker-compose up -d --build

            echo ""
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
            sleep 30

            echo ""
            echo "ðŸ—„ï¸ Ð—Ð°Ð¿ÑƒÑÐº Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…:"
            docker-compose exec -T app npx prisma migrate deploy || echo "ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ (Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÐµÑ‰Ðµ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾)"

            echo ""
            echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
            docker-compose ps

            echo ""
            echo "ðŸ§¹ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹:"
            docker image prune -f

            echo ""
            echo "ðŸ¥ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:"
            curl -f http://localhost:3000/health || echo "Health check Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐµÐ»"

      - name: Send Telegram success message
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            âœ… *Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ VPN-BOT!*

            ðŸ—‚ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: `${{ github.repository }}`
            ðŸŒ¿ Ð’ÐµÑ‚ÐºÐ°: `${{ github.ref_name }}`
            ðŸ”¨ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            ðŸŒ Ð¡ÐµÑ€Ð²ÐµÑ€: `${{ secrets.SSH_HOST }}`
            ðŸ¤– Ð‘Ð¾Ñ‚: Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ

            ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿ÐµÑ€ÐµÑÐ¾Ð±Ñ€Ð°Ð½Ñ‹, Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹, Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹, ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹.

      - name: Send Telegram failure message
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            âŒ *ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ðµ VPN-BOT!*

            ðŸ—‚ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: `${{ github.repository }}`
            ðŸŒ¿ Ð’ÐµÑ‚ÐºÐ°: `${{ github.ref_name }}`
            ðŸ”¨ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            âš ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ GitHub Actions Ð»Ð¾Ð³: [ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ñ€ÑƒÑ‡Ð½Ð¾Ðµ Ð²Ð¼ÐµÑˆÐ°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾ Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ°.
